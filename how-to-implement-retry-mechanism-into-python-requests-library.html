<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=robots content="index,follow,noarchive"><title>How to implement retry mechanism into Python Requests library? - WeBlogy</title><meta name=description content="I would like to add a retry mechanism to Python Requests library, so scripts that are using it will retry for non-fatal errors. At this moment I do consider three kind of errors to be recoverable: At the first stage I do want to retry specified 5xx requests every minute."><meta name=author content="Some Person"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"WeBlogy","url":"\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"\/how-to-implement-retry-mechanism-into-python-requests-library.html","name":"How to implement retry mechanism into python requests library?"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Patria Henriques"},"headline":"How to implement retry mechanism into Python Requests library?","description":"I would like to add a retry mechanism to Python Requests library, so scripts that are using it will retry for non-fatal errors. At this moment I do consider three kind of errors to be recoverable: At the first stage I do want to retry specified 5xx requests every minute.","inLanguage":"en","wordCount":806,"datePublished":"2024-08-26T00:00:00","dateModified":"2024-08-26T00:00:00","image":"\/img\/avatar-icon.png","keywords":[""],"mainEntityOfPage":"\/how-to-implement-retry-mechanism-into-python-requests-library.html","publisher":{"@type":"Organization","name":"\/","logo":{"@type":"ImageObject","url":"\/img\/avatar-icon.png","height":60,"width":60}}}</script><meta property="og:title" content="How to implement retry mechanism into Python Requests library?"><meta property="og:description" content="I would like to add a retry mechanism to Python Requests library, so scripts that are using it will retry for non-fatal errors. At this moment I do consider three kind of errors to be recoverable: At the first stage I do want to retry specified 5xx requests every minute."><meta property="og:image" content="/img/avatar-icon.png"><meta property="og:url" content="/how-to-implement-retry-mechanism-into-python-requests-library.html"><meta property="og:type" content="website"><meta property="og:site_name" content="WeBlogy"><meta name=twitter:title content="How to implement retry mechanism into Python Requests library?"><meta name=twitter:description content="I would like to add a retry mechanism to Python Requests library, so scripts that are using it will retry for non-fatal errors. At this moment I do consider three kind of errors to be recoverable: At â€¦"><meta name=twitter:image content="/img/avatar-icon.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@username"><meta name=twitter:creator content="@username"><link href=./img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.98.0"><link rel=alternate href=./index.xml type=application/rss+xml title=WeBlogy><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://assets.cdnweb.info/hugo/bh/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://assets.cdnweb.info/hugo/bh/css/highlight.min.css><link rel=stylesheet href=https://assets.cdnweb.info/hugo/bh/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>How to implement retry mechanism into Python Requests library?</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 26, 2024
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;806&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Patria Henriques</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><img src=https://cdn.statically.io/img/cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png style=margin:auto;display:block;text-align:center;max-width:100%;height:auto><p>I would like to add a retry mechanism to Python <a href=# rel=noreferrer>Requests</a> library, so scripts that are using it will retry for non-fatal errors.</p><p>At this moment I do consider three kind of errors to be recoverable:</p><ul><li>HTTP return codes 502, 503, 504</li><li>host not found (less important now)</li><li>request timeout</li></ul><p>At the first stage I do want to retry specified 5xx requests every minute.</p><p>I want to be able to add this functionality transparently, without having to manually implement recovery for each HTTP call made from inside these scripts or libraries that are using Python Requests.</p><span class=d-none itemprop=commentCount>5</span><h2 class=mb0 data-answercount=6>6 Answers</h2><p>This snippet of code will make all HTTP requests from the same session retry for a total of 5 times, sleeping between retries with an increasing backoff of 0s, 2s, 4s, 8s, 16s (the first retry is done immediately). It will retry on basic connectivity issues (including DNS lookup failures), and HTTP status codes of 502, 503 and 504.</p><pre><code>import logging import requests from requests.adapters import HTTPAdapter, Retry logging.basicConfig(level=logging.DEBUG) s = requests.Session() retries = Retry(total=5, backoff_factor=1, status_forcelist=[ 502, 503, 504 ]) s.mount('http://', HTTPAdapter(max_retries=retries)) s.get("http://httpstat.us/503") </code></pre><p>See <a href=# rel=noreferrer>Retry class</a> for details.</p><span class=d-none itemprop=commentCount>11</span><p>This is a snippet of code I used to retry for the petitions made with urllib2. Maybe you could use it for your purposes:</p><pre><code>retries = 1 success = False while not success: try: response = urllib2.urlopen(request) success = True except Exception as e: wait = retries * 30; print 'Error! Waiting %s secs and re-trying...' % wait sys.stdout.flush() time.sleep(wait) retries += 1 </code></pre><p>The waiting time grows incrementally to avoid be banned from server.</p><span class=d-none itemprop=commentCount>2</span><p>Possible solution using <a href=# rel=noreferrer>retrying package</a></p><pre><code>from retrying import retry import requests def retry_if_connection_error(exception): """ Specify an exception you need. or just True""" #return True return isinstance(exception, ConnectionError) # if exception retry with 2 second wait @retry(retry_on_exception=retry_if_connection_error, wait_fixed=2000) def safe_request(url, **kwargs): return requests.get(url, **kwargs) response = safe_request('test.com') </code></pre><span class=d-none itemprop=commentCount>3</span><pre><code>from requests.adapters import HTTPAdapter from urllib3.util.retry import Retry MAX_RETRY = 2 MAX_RETRY_FOR_SESSION = 2 BACK_OFF_FACTOR = 0.3 TIME_BETWEEN_RETRIES = 1000 ERROR_CODES = (500, 502, 504) def requests_retry_session(retries=MAX_RETRY_FOR_SESSION, back_off_factor=BACK_OFF_FACTOR, status_force_list=ERROR_CODES, session=None): session = session retry = Retry(total=retries, read=retries, connect=retries, backoff_factor=back_off_factor, status_forcelist=status_force_list, method_whitelist=frozenset(['GET', 'POST'])) adapter = HTTPAdapter(max_retries=retry) session.mount('http://', adapter) session.mount('https://', adapter) return session class ConfigService: def __init__(self): self.session = requests_retry_session(session=requests.Session()) def call_to_api(): config_url = 'http://localhost:8080/predict/' headers = { "Content-Type": "application/json", "x-api-key": self.x_api_key } response = self.session.get(config_url, headers=headers) return response </code></pre><span class=d-none itemprop=commentCount>1</span><p>I was able to obtain the desired level of reliability by extending <code>requests.Session</code> class.</p><p>Here is the code <a href=# rel="nofollow noreferrer">https://bitbucket.org/bspeakmon/jira-python/src/a7fca855394402f58507ca4056de87ccdbd6a213/jira/resilientsession.py?at=master</a></p><p><strong>EDIT</strong> That code was:</p><pre><code>from requests import Session from requests.exceptions import ConnectionError import logging import time class ResilientSession(Session): """ This class is supposed to retry requests that do return temporary errors. At this moment it supports: 502, 503, 504 """ def __recoverable(self, error, url, request, counter=1): if hasattr(error,'status_code'): if error.status_code in [502, 503, 504]: error = "HTTP %s" % error.status_code else: return False DELAY = 10 * counter logging.warn("Got recoverable error [%s] from %s %s, retry #%s in %ss" % (error, request, url, counter, DELAY)) time.sleep(DELAY) return True def get(self, url, **kwargs): counter = 0 while True: counter += 1 try: r = super(ResilientSession, self).get(url, **kwargs) except ConnectionError as e: r = e.message if self.__recoverable(r, url, 'GET', counter): continue return r def post(self, url, **kwargs): counter = 0 while True: counter += 1 try: r = super(ResilientSession, self).post(url, **kwargs) except ConnectionError as e: r = e.message if self.__recoverable(r, url, 'POST', counter): continue return r def delete(self, url, **kwargs): counter = 0 while True: counter += 1 try: r = super(ResilientSession, self).delete(url, **kwargs) except ConnectionError as e: r = e.message if self.__recoverable(r, url, 'DELETE', counter): continue return r def put(self, url, **kwargs): counter = 0 while True: counter += 1 try: r = super(ResilientSession, self).put(url, **kwargs) except ConnectionError as e: r = e.message if self.__recoverable(r, url, 'PUT', counter): continue return r def head(self, url, **kwargs): counter = 0 while True: counter += 1 try: r = super(ResilientSession, self).head(url, **kwargs) except ConnectionError as e: r = e.message if self.__recoverable(r, url, 'HEAD', counter): continue return r def patch(self, url, **kwargs): counter = 0 while True: counter += 1 try: r = super(ResilientSession, self).patch(url, **kwargs) except ConnectionError as e: r = e.message if self.__recoverable(r, url, 'PATCH', counter): continue return r def options(self, url, **kwargs): counter = 0 while True: counter += 1 try: r = super(ResilientSession, self).options(url, **kwargs) except ConnectionError as e: r = e.message if self.__recoverable(r, url, 'OPTIONS', counter): continue return r </code></pre><span class=d-none itemprop=commentCount>4</span><p><strong>Method to retry certain logic if some exception has occured at time intervals t1=1 sec, t2=2 sec, t3=4 sec.</strong> We can increase/decrease the time interval as well.</p><pre><code>MAX_RETRY = 3 retries = 0 try: call_to_api() // some business logic goes here. except Exception as exception: retries += 1 if retries &lt;= MAX_RETRY: print("ERROR=Method failed. Retrying ... #%s", retries) time.sleep((1 &lt;&lt; retries) * 1) // retry happens after time as a exponent of 2 continue else: raise Exception(exception) </code></pre><span class=d-none itemprop=commentCount></span><p class=postsid style=color:rgba(255,0,0,0)>ncG1vNJzZmirpJawrLvVnqmfpJ%2Bse6S7zGiorp2jqbawutJoaWxqZmyBcYWOoaawZaSkeqq5z6Wcpp2eqXqzsdOrsGallZi1orrIrKRmoZ6pvG682K2fqKZdp7KywcSsq6xlnJ6vs63Rsg%3D%3D</p><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=%2fhow-to-implement-retry-mechanism-into-python-requests-library.html&text=How%20to%20implement%20retry%20mechanism%20into%20Python%20Requests%20library%3f&via=username" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=%2fhow-to-implement-retry-mechanism-into-python-requests-library.html" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=%2fhow-to-implement-retry-mechanism-into-python-requests-library.html&title=How%20to%20implement%20retry%20mechanism%20into%20Python%20Requests%20library%3f" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=%2fhow-to-implement-retry-mechanism-into-python-requests-library.html&title=How%20to%20implement%20retry%20mechanism%20into%20Python%20Requests%20library%3f" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=%2fhow-to-implement-retry-mechanism-into-python-requests-library.html&title=How%20to%20implement%20retry%20mechanism%20into%20Python%20Requests%20library%3f" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=%2fhow-to-implement-retry-mechanism-into-python-requests-library.html&description=How%20to%20implement%20retry%20mechanism%20into%20Python%20Requests%20library%3f" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=./lies-p-weapon-upgrade-guide-how-upgrade-vendors.html data-toggle=tooltip data-placement=top title="How to upgrade, vendors, and more">&larr; Previous Post</a></li><li class=next><a href=./how-does-tyler-the-creator-without-hat-does-he.html data-toggle=tooltip data-placement=top title="How Does Tyler The Creator Without Hat Look? Does He Wear A Wig?">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">All rights reserved
&nbsp;&bull;&nbsp;&copy;
2024
&nbsp;&bull;&nbsp;
<a href=./>WeBlogy</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.98.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://assets.cdnweb.info/hugo/bh/js/main.js></script>
<script src=https://assets.cdnweb.info/hugo/bh/js/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://assets.cdnweb.info/hugo/bh/js/load-photoswipe.js></script>
<script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://iklan.listspress.com/floating.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://iklan.listspress.com/tracking_server_3.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//analytics.cdnweb.info/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script></body></html>